---
title: "STA522 Project2"
author: "Holly Cui, Elyse McFalls"
date: "2023-12-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
```

##  Overview

While paper helicopters may seem like child's play, have you ever pondered the strategic nuances behind crafting the optimal design to conquer the skies? In the realm of whimsical flights and childhood contests, we dissect the intricacies of paper helicopter design, armed with the fundamental tools of inquiry – regular paper, a pair of scissors, and a humble paperclip, to explore the relationship between paper helicopter features and flight duration. Specifically, we focuses on four major factors in helicopter designs that are commonly assumed to effective – the rotor length, the leg length, the leg width, and the paperclip-on-leg maneuver. By altering the combinations of these factors, we aim to answer the following research questions:

1. Which factors seem to be the most important for making helicopters that fly longer (in terms of time)?
2. Is there any evidence that the effect of rotor length differs by leg width?
3. What would be recommended as the ideal combination to make the helicopter fly long (in terms of time)?

## Methodology

In this study, we performed a full factorial randomized experiment on all $2^4$ combinations of the main factors. Each combination is sampled 5 flights, leading to a total of 80 observations as our sample size. During the sampling process, the treatment values are randomly permuted under the guideline of a randomized experiment, and the flight duration is sequentially collected by dropping the assigned combination of paper helicopter from a fixed height of 6'6''. 

Upon designing the experiment, we believe that the full factorial methodology presents the best balance between reliability and convenience. Since our research questions are interested in determining the best combination of all four factors, we wanted to make sure that the main effects of each factor as well as the interaction effects can be estimated without further assumptions. Thus, the alternative of a fractional factorial design would either not allow us to calculate all effects due to aliasing, or require tedious planning on how to optimally craft the design. Considering $2^4$ combinations is an acceptable level of time commitment on data collection, we decided to pursue on the full factorial design.

For reference, the 16 conditions of paper helicopters are defined as follows:

ID     Treatment                                ID           Treatment
---    ----------------------                   --------     --------------------
a      Only high rotor length                   bd           High leg length & leg clip
b      Only high leg length                     cd           High leg width & leg clip
c      Only high leg width                      abc          High rotor length & high leg length & high leg width
d      Only leg clip                            abd          High rotor length & high leg length & leg clip
ab     High rotor length & high leg length      acd          High rotor length & high leg width & leg clip
ac     High rotor length & high leg width       bcd          High leg length & high leg width & leg clip
ad     High rotor length & leg clip             abcd         High on all factors
bc     High leg length & high leg width         1            Low on all factors

where the levels of highs and lows are defined as: 

  - Rotor length: low = 7.5 cm, high = 8.5 cm
  - Leg length: low = 7.5 cm, high = 12.0 cm
  - Leg width: low = 3.2 cm, high = 5.0 cm
  - Leg clip: no, yes

The randomizations of treatments are generated in R: 

```{r}
set.seed(123)
trt = c(rep("a", 5), rep("b", 5), rep("c", 5), rep("d", 5),
        rep("ab", 5), rep("ac", 5), rep("ad", 5), rep("bc", 5),
        rep("bd", 5), rep("cd", 5), rep("abc", 5), rep("abd", 5),
        rep("acd", 5), rep("bcd", 5), rep("abcd", 5), rep("1", 5))
sample(trt)
```

Here is a sneak peek of our final dataframe, where variable `time` is measured in seconds, variable `trt` represents the treatment combinations, and variables `rotor`, `leg_len`, `leg_wid`, and `clip` are binary indicators of the presence of high/yes (=1) or low/no (=0):

```{r}
plane = read.csv("paperplane.csv", header = T)
head(plane) # dimension: 80 rows 6 columns
```

## Exploratory Data Analysis

```{r}
plane <- plane %>%
  mutate(rotor = as.factor(rotor),
         leg_len = as.factor(leg_len),
         leg_wid = as.factor(leg_wid),
         clip = as.factor(clip))
```


```{r}
ggplot(plane, aes(x = time*100)) + 
  geom_histogram(aes(y=after_stat(density)), 
                 binwidth=7, color="black", fill="grey") + 
  geom_vline(aes(xintercept = mean(time)*100),
             color="blue", linetype="dashed", linewidth=1) +
  geom_density(alpha=.2, fill="#FF6666") +
  labs(title = "Distribution of Helicopter Flight Duration", 
       x = "Time (sec * 100)", y = "Count")
```
  - Insights: The data appears to be almost bimodal with a peak around 1.6 seconds and another around 1.9 seconds. The average time overall was `r round(mean(plane$time), 2)`. 


```{r}
plane %>%
  group_by(trt) %>%
  summarise(mean_time = mean(time*100)) %>%
  arrange(desc(mean_time)) %>%
  ggplot(aes(y = mean_time, x = fct_rev(fct_reorder(trt, mean_time)))) + 
  geom_col(color="black", fill="grey") + 
  geom_hline(aes(yintercept = mean(mean_time)),
             color="blue", linetype="dashed", linewidth=1) +
  labs(title = "Average Flight Duration by Treatments", 
       x = "Treatment", y = "Average Time (sec * 100)")
```
  - Insights: the presence of a - long rotor seems to be helping long duration. the presence of d is discouraging long duration.
  Looking at the average distance per treatment combination, we see that helicopters with high rotor length and high leg width last the longest in the air. Moreover, the top 6 combinations all include high rotor length, indicating that this factor may contribute to longer flight times. Conversely, helicopters with high leg length, high leg width, and a leg clip are the quickest to go down. Interestingly, this combination is high on all levels except a, high rotor length. Six of the eight worst combinations by average flight time have low rotor length. 


```{r}
plane %>%
  mutate(trt = factor(trt, levels = c("ac", "ad", "ab", "a", 
                                      "abd", "abc", "1", "b", 
                                      "d", "c", "bc", "acd", 
                                      "bd", "abcd", "cd", "bcd"))) %>%
ggplot(aes(x = trt, y = time*100)) + 
  geom_boxplot() + 
  labs(title = "Distribution of Flight Duration by Treatments", 
       x = "Treatment", y = "Duraction (sec * 100)")

tapply(plane[,1], plane[,6], sd)
```
  - Insights: box plots are difficult to interpret with only 5 or so observations per box, but we can still observe 
    - an outlier in treatment bcd and other groups: we may want to estimate the model with and without that point to see if our conclusions are overly sensitive to that point. But since most outliers in groups are within the normal range, we don't worry too much. 
    - Along w previous plot, we might need to resolve the problem of distribution of time is right-skewed.
    - The var for group d and acd are relatively larger. However, since the total duration is measured under second, the largest difference is only several miliseconds away, so we can use regression under the equal var assumption. (from the math calculation, most of them confirmed to be the same --> with very small sample size, it is difficult to conclude definitively that the variances are different across groups.)
    

## Modeling 

```{r}
# main effect model
mod.main = lm(time ~ rotor + leg_len + leg_wid + clip, data = plane)
summary(mod.main)
```

```{r}
par(mfrow = c(2,2))
plot(mod.main)
```

```{r}
# model with 2-way interactions
mod.twoway = lm(time ~ rotor + leg_len + leg_wid + clip + rotor:leg_len + 
                rotor:leg_wid + rotor:clip + leg_len:leg_wid + leg_len:clip +
                leg_wid:clip, data = plane)
summary(mod.twoway)
```

```{r}
par(mfrow = c(2,2))
plot(mod.twoway)
```

```{r}
# model with 3-way interactions
mod.all = lm(time ~ rotor * leg_len * leg_wid * clip, data = plane)
summary(mod.all)
```


```{r}
par(mfrow = c(2,2))
plot(mod.all)
```

### Nested F-Tests

```{r}
#main effects vs. two-way
anova(mod.main, mod.twoway, test='F')
```

```{r}
#main effects vs. three-way
anova(mod.main, mod.all, test='F')
```

```{r}
#two-way vs. three-way
anova(mod.twoway, mod.all, test='F')
```

 Two-way > All > Main: two way interactions are the most significant, but three-way seems to be not significant compared with two-way. 

# in and out F-test -> p-value most important 
# R-squared change -> which one change the most 

# Q3: expected mean -> beta add up -> CI (change baselines) -> each baseline new CI 


To find the best combination of factors, we derived the average time, in seconds, that a helicopter is expected to fly for all combinations along with each estimate's 95% confidence interval. We found these values by modifying the baseline values so the intercept estimate corresponded with our combination of interest. The 95% confidence interval for the intercept estimate then served as our confidence interval for the expected average flight time of a helicopter with the specified combination of values. 

These calculations involved creating four new variables -- `rotor_low`: signifies low rotor length, `leg_len_low`: signifies low leg length, `leg_wid_low`: signifies low width length, `clip_low`: signifies the absence of a clip. Then, a full four-way model was calculated based on the combination of interest. For instance, if we were interested in the combination low rotor length, low leg length, high leg width, and a clip (treatment cd), we would specify the model `time ~ rotor * leg_len * leg_wid_low * clip_low`. This formula gives us a baseline value that corresponds with our combination of interest, and therefore the estimate of the intercept is $E[\bar{y}_{cd}]$. 

```{r}
plane$rotor_low = 1 - as.numeric(plane$rotor)
plane$leg_len_low =  1 - as.numeric(plane$leg_len)
plane$leg_wid_low = 1 -  as.numeric(plane$leg_wid)
plane$clip_low =  1 - as.numeric(plane$clip)
```

```{r}
plane <- plane %>%
  mutate(rotor_low = as.factor(rotor_low),
         leg_len_low = as.factor(leg_len_low),
         leg_wid_low = as.factor(leg_wid_low),
         clip_low = as.factor(clip_low))
```

```{r}
# example for treatment cd
cd = lm(time ~ rotor * leg_len * leg_wid_low * clip_low, data = plane)
summary(cd)$coefficients[1,]
```

```{r}
# 95% CI for treatment cd (intercept)
confint(cd)[1,]
```


The expected average time in seconds for each helicopter alteration is listed below:

Combination            Lower          Estimate          Upper
------------           ---------      ------------      -------------
(0)                    1.795          1.92              2.045
a                      1.815          1.94              2.065
b                      1.787          1.912             2.037
c                      1.735          1.86              1.985
d                      1.771          1.896             2.021
ab                     1.873          1.998             2.123
ac                     2.031          2.156             2.281
ad                     1.991          2.116             2.241
bc                     1.731          1.856             1.981
bd                     1.561          1.686             1.811
cd                     1.455          1.58              1.705
abc                    1.795          1.92              2.045   
abd                    1.801          1.926             2.052
acd                    1.599          1.724             1.849
bcd                    1.335          1.46              1.585 
abcd                   1.499          1.624             1.749


As expected from the exploratory data analysis, the helicopters with high rotor length and high leg (treatment ac) width are expected to last longer in the air by an average of 2.156 seconds and a 95% confidence interval of (2.031sec, 2.281sec). Therefore, we select this combination as the best. However, the combination of high rotor length and a clip (treatment ad) was not far behind with an expected average of 2.116 seconds and a 95% confidence interval of (1.991sec, 2.241sec). Other combinations with overlapping confidence intervals to treatment ac include treatment ab (1.998, (1.873, 2.123)), a (1.94, (1.815, 2.065)), abd (1.926, (1.801, 2.052)), (0) (1.92, (1.795, 2.045)), abc (1.92, (1.795, 2.045)), and b (1.912, (1.787, 2.037)). These all have the potential to perform as well, or even better, than our chosen combination. 











